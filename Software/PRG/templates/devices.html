{% extends "base.html" %}

{% block title %}Geräteliste - Benning Device Manager{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-8">
        <h1>
            <i class="fas fa-list"></i> Geräteliste
        </h1>
    </div>
    <div class="col-md-4 text-end">
        <!-- Action Buttons -->
        <a href="/quick-add" class="btn btn-primary me-2">
            <i class="fas fa-plus"></i> Neues Gerät
        </a>
        <button class="btn btn-print me-2" onclick="printPage()">
            <i class="fas fa-print"></i> Drucken
        </button>
        <a href="/pdf/devices" class="btn btn-danger" target="_blank">
            <i class="fas fa-file-pdf"></i> PDF
        </a>
    </div>
</div>

<!-- Filter und Suche -->
<div class="row mb-3">
    <div class="col-md-6">
        <div class="input-group">
            <span class="input-group-text" style="background-color: #34495e; border-color: #34495e;">
                <i class="fas fa-search"></i>
            </span>
            <input type="text" id="searchInput" class="form-control" placeholder="Suche nach Name, Kunde oder Seriennummer...">
        </div>
    </div>
    <div class="col-md-3">
        <select id="statusFilter" class="form-select">
            <option value="">Alle Status</option>
            <option value="active">Aktiv</option>
            <option value="inactive">Inaktiv</option>
            <option value="maintenance">Wartung</option>
            <option value="retired">Ausgemustert</option>
        </select>
    </div>
    <div class="col-md-3">
        <button class="btn btn-outline-secondary w-100" onclick="resetFilters()">
            <i class="fas fa-redo"></i> Zurücksetzen
        </button>
    </div>
</div>

<!-- Geräteliste -->
<div class="table-responsive">
    <table class="table table-striped table-hover" id="devicesTable">
        <thead>
            <tr>
                <th>ID</th>
                <th>Kundenname</th>
                <th>Geräte-ID</th>
                <th>Name</th>
                <th>Typ</th>
                <th>Seriennummer</th>
                <th>Standort</th>
                <th>Status</th>
                <th>Aktionen</th>
            </tr>
        </thead>
        <tbody id="devicesList">
            <!-- Wird mit JavaScript gefüllt -->
        </tbody>
    </table>
    <div id="emptyMessage" class="alert alert-info text-center" style="display: none;">
        <i class="fas fa-inbox"></i>
        <p>Keine Geräte vorhanden</p>
    </div>
</div>

<style>
    h1 {
        color: var(--secondary-color);
        margin-bottom: 1.5rem;
        font-weight: bold;
    }
    
    .status-badge {
        padding: 0.35rem 0.65rem;
        border-radius: 0.25rem;
        font-weight: 500;
        display: inline-block;
    }
    
    .status-active {
        background-color: #27ae60;
        color: white;
    }
    
    .status-inactive {
        background-color: #e74c3c;
        color: white;
    }
    
    .status-maintenance {
        background-color: #f39c12;
        color: white;
    }
    
    .status-retired {
        background-color: #95a5a6;
        color: white;
    }
    
    .btn-outline-secondary {
        color: var(--secondary-color);
        border-color: var(--secondary-color);
    }
    
    .btn-outline-secondary:hover {
        background-color: var(--secondary-color);
        border-color: var(--secondary-color);
        color: var(--primary-color);
    }
    
    .input-group-text {
        color: var(--secondary-color);
    }
    
    /* Print Styles */
    @media print {
        .row.mb-4, .row.mb-3, .btn, .input-group, .form-select {
            display: none !important;
        }
        
        body {
            background-color: white;
        }
        
        h1 {
            color: black;
            page-break-after: avoid;
        }
        
        .table {
            background-color: white;
            color: black;
        }
        
        .table th {
            background-color: #f0f0f0;
            color: black;
            border: 1px solid #ddd;
        }
        
        .table td {
            border: 1px solid #ddd;
            color: black;
        }
        
        .table-hover tbody tr:hover {
            background-color: white;
        }
    }
</style>

<script>
    // Lade Geräte beim Seitenladen
    document.addEventListener('DOMContentLoaded', function() {
        loadDevices();
        setupFilters();
    });

    function loadDevices() {
        fetch('/api/devices')
            .then(response => response.json())
            .then(data => {
                if (data.success && data.devices) {
                    displayDevices(data.devices);
                } else {
                    showEmptyMessage();
                }
            })
            .catch(error => {
                console.error('Fehler beim Laden der Geräte:', error);
                showEmptyMessage();
            });
    }

    function displayDevices(devices) {
        const tbody = document.getElementById('devicesList');
        const emptyMessage = document.getElementById('emptyMessage');

        if (devices.length === 0) {
            showEmptyMessage();
            return;
        }

        emptyMessage.style.display = 'none';
        tbody.innerHTML = '';

        devices.forEach(device => {
            const row = document.createElement('tr');
            const statusClass = `status-${device.status || 'active'}`;
            
            row.innerHTML = `
                <td>${device.id}</td>
                <td><strong>${device.customer}</strong></td>
                <td><code>${device.customer_device_id}</code></td>
                <td>${device.name}</td>
                <td>${device.type || '-'}</td>
                <td>${device.serial_number || '-'}</td>
                <td>${device.location || '-'}</td>
                <td>
                    <span class="status-badge ${statusClass}">
                        ${device.status || 'active'}
                    </span>
                </td>
                <td>
                    <a href="/device/${device.id}" class="btn btn-sm btn-primary">
                        <i class="fas fa-eye"></i> Details
                    </a>
                </td>
            `;
            tbody.appendChild(row);
        });
    }

    function showEmptyMessage() {
        document.getElementById('emptyMessage').style.display = 'block';
        document.getElementById('devicesList').innerHTML = '';
    }

    function setupFilters() {
        const searchInput = document.getElementById('searchInput');
        const statusFilter = document.getElementById('statusFilter');

        searchInput.addEventListener('keyup', filterTable);
        statusFilter.addEventListener('change', filterTable);
    }

    function filterTable() {
        const searchInput = document.getElementById('searchInput').value.toLowerCase();
        const statusFilter = document.getElementById('statusFilter').value;
        const rows = document.getElementById('devicesList').getElementsByTagName('tr');

        let visibleCount = 0;

        Array.from(rows).forEach(row => {
            const text = row.textContent.toLowerCase();
            const status = row.cells[7]?.textContent.trim().toLowerCase() || '';

            const matchesSearch = text.includes(searchInput);
            const matchesStatus = !statusFilter || status.includes(statusFilter);

            if (matchesSearch && matchesStatus) {
                row.style.display = '';
                visibleCount++;
            } else {
                row.style.display = 'none';
            }
        });

        // Zeige "Keine Ergebnisse" wenn nichts gefunden
        if (visibleCount === 0) {
            document.getElementById('emptyMessage').style.display = 'block';
        } else {
            document.getElementById('emptyMessage').style.display = 'none';
        }
    }

    function resetFilters() {
        document.getElementById('searchInput').value = '';
        document.getElementById('statusFilter').value = '';
        filterTable();
    }
</script>
{% endblock %}
