{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <div class="row mb-4">
        <div class="col-md-8">
            <h1>Geräteliste</h1>
        </div>
        <div class="col-md-4 text-end">
            <!-- PDF Export Buttons -->
            <a href="/pdf/devices" class="btn btn-danger me-2" target="_blank">
                <i class="fas fa-file-pdf"></i> Alle Geräte als PDF
            </a>
            {% if current_customer %}
            <a href="/pdf/devices/customer/{{ current_customer }}" class="btn btn-danger" target="_blank">
                <i class="fas fa-file-pdf"></i> Kunde PDF
            </a>
            {% endif %}
        </div>
    </div>

    <!-- Filter und Suche -->
    <div class="row mb-3">
        <div class="col-md-6">
            <input type="text" id="searchInput" class="form-control" placeholder="Suche nach Name, Kunde oder Seriennummer...">
        </div>
        <div class="col-md-6">
            <select id="statusFilter" class="form-select">
                <option value="">Alle Status</option>
                <option value="active">Aktiv</option>
                <option value="inactive">Inaktiv</option>
                <option value="maintenance">Wartung</option>
                <option value="retired">Ausgemustert</option>
            </select>
        </div>
    </div>

    <!-- Geräteliste -->
    <div class="table-responsive">
        <table class="table table-striped table-hover" id="devicesTable">
            <thead class="table-dark">
                <tr>
                    <th>ID</th>
                    <th>Kundenname</th>
                    <th>Geräte-ID</th>
                    <th>Name</th>
                    <th>Typ</th>
                    <th>Seriennummer</th>
                    <th>Standort</th>
                    <th>Status</th>
                    <th>Aktionen</th>
                </tr>
            </thead>
            <tbody id="devicesList">
                <!-- Wird mit JavaScript gefüllt -->
            </tbody>
        </table>
        <div id="emptyMessage" class="alert alert-info text-center" style="display: none;">
            <p>Keine Geräte vorhanden</p>
        </div>
    </div>
</div>

<style>
    .btn-danger {
        background-color: #dc3545;
        border-color: #dc3545;
    }

    .btn-danger:hover {
        background-color: #c82333;
        border-color: #bd2130;
    }

    .status-badge {
        padding: 0.35rem 0.65rem;
        border-radius: 0.25rem;
        font-weight: 500;
    }

    .status-active {
        background-color: #d4edda;
        color: #155724;
    }

    .status-inactive {
        background-color: #f8d7da;
        color: #721c24;
    }

    .status-maintenance {
        background-color: #fff3cd;
        color: #856404;
    }

    .status-retired {
        background-color: #e2e3e5;
        color: #383d41;
    }

    .table-hover tbody tr:hover {
        background-color: #f5f5f5;
    }
</style>

<script>
    // Lade Geräte beim Seitenladen
    document.addEventListener('DOMContentLoaded', function() {
        loadDevices();
        setupFilters();
    });

    function loadDevices() {
        fetch('/api/devices')
            .then(response => response.json())
            .then(data => {
                if (data.success && data.devices) {
                    displayDevices(data.devices);
                } else {
                    showEmptyMessage();
                }
            })
            .catch(error => {
                console.error('Fehler beim Laden der Geräte:', error);
                showEmptyMessage();
            });
    }

    function displayDevices(devices) {
        const tbody = document.getElementById('devicesList');
        const emptyMessage = document.getElementById('emptyMessage');

        if (devices.length === 0) {
            showEmptyMessage();
            return;
        }

        emptyMessage.style.display = 'none';
        tbody.innerHTML = '';

        devices.forEach(device => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${device.id}</td>
                <td>${device.customer}</td>
                <td><strong>${device.customer_device_id}</strong></td>
                <td>${device.name}</td>
                <td>${device.type || '-'}</td>
                <td>${device.serial_number || '-'}</td>
                <td>${device.location || '-'}</td>
                <td>
                    <span class="status-badge status-${device.status || 'active'}">
                        ${device.status || 'active'}
                    </span>
                </td>
                <td>
                    <a href="/device/${device.id}" class="btn btn-sm btn-primary">
                        <i class="fas fa-eye"></i> Details
                    </a>
                </td>
            `;
            tbody.appendChild(row);
        });
    }

    function showEmptyMessage() {
        document.getElementById('emptyMessage').style.display = 'block';
        document.getElementById('devicesList').innerHTML = '';
    }

    function setupFilters() {
        const searchInput = document.getElementById('searchInput');
        const statusFilter = document.getElementById('statusFilter');

        searchInput.addEventListener('keyup', filterTable);
        statusFilter.addEventListener('change', filterTable);
    }

    function filterTable() {
        const searchInput = document.getElementById('searchInput').value.toLowerCase();
        const statusFilter = document.getElementById('statusFilter').value;
        const rows = document.getElementById('devicesList').getElementsByTagName('tr');

        let visibleCount = 0;

        Array.from(rows).forEach(row => {
            const text = row.textContent.toLowerCase();
            const status = row.cells[7]?.textContent.trim().toLowerCase() || '';

            const matchesSearch = text.includes(searchInput);
            const matchesStatus = !statusFilter || status.includes(statusFilter);

            if (matchesSearch && matchesStatus) {
                row.style.display = '';
                visibleCount++;
            } else {
                row.style.display = 'none';
            }
        });

        // Zeige "Keine Ergebnisse" wenn nichts gefunden
        if (visibleCount === 0) {
            document.getElementById('emptyMessage').style.display = 'block';
        } else {
            document.getElementById('emptyMessage').style.display = 'none';
        }
    }

    // PDF Export Funktion
    function exportPDF(type = 'all', customer = null) {
        let url = '/pdf/devices';
        if (type === 'customer' && customer) {
            url = `/pdf/devices/customer/${customer}`;
        }
        window.open(url, '_blank');
    }
</script>
{% endblock %}
<style>
.qr-code-small {
    width: 60px;
    height: 60px;
    border: 1px solid #ddd;
    padding: 2px;
    cursor: pointer;
    transition: transform 0.2s;
}

.qr-code-small:hover {
    transform: scale(1.2);
    border: 2px solid #007bff;
}

.text-muted {
    color: #999;
}

.alert {
    padding: 12px 16px;
    margin-bottom: 20px;
    border-radius: 4px;
    border-left: 4px solid;
}

.alert-danger {
    background-color: #f8d7da;
    color: #721c24;
    border-color: #f5c6cb;
}

.alert-info {
    background-color: #d1ecf1;
    color: #0c5460;
    border-color: #bee5eb;
}
</style>