{% extends "base.html" %}

{% block title %}Schnellerfassung - Benning Device Manager{% endblock %}

{% block content %}
<div class="quick-add">
    <h2>‚ö° Schnellerfassung</h2>
    
    <form id="quickAddForm">
        <!-- Kunde Feld (NEU) -->
        <div class="form-group">
            <label>Kunde: *</label>
            <input type="text" name="customer" id="customerInput" required autofocus 
                   placeholder="z.B. Parloa, Siemens, etc.">
            <small>Die Device ID wird als "Kunde-00001" formatiert</small>
        </div>
        
        <div class="form-group">
            <label>Ger√§te-ID:</label>
            <input type="text" id="deviceId" name="device_id" readonly 
                   placeholder="Wird automatisch generiert">
        </div>
        
        <div class="form-group">
            <label>Ger√§tename: *</label>
            <input type="text" name="name" required>
        </div>
        
        <div class="form-group">
            <label>Typ:</label>
            <select name="type" id="deviceType">
                <option value="Elektrowerkzeug">Elektrowerkzeug</option>
                <option value="Kabel">Kabel</option>
                <option value="USB-Kabel">USB-Kabel</option>
                <option value="Verl√§ngerung">Verl√§ngerung</option>
                <option value="Reinigungsger√§t">Reinigungsger√§t</option>
                <option value="Sonstiges">Sonstiges</option>
            </select>
        </div>
        
        <div class="form-group">
            <label>Standort:</label>
            <input type="text" name="location">
        </div>
        
        <div class="form-group">
            <label>Hersteller:</label>
            <input type="text" name="manufacturer">
        </div>
        
        <div class="form-group">
            <label>Seriennummer:</label>
            <input type="text" name="serial_number">
        </div>
        
        <div class="form-group">
            <label>Kaufdatum:</label>
            <input type="date" name="purchase_date">
        </div>
        
        <div class="form-section">
            <h3>üìã Pr√ºfinformationen</h3>
            
            <div class="form-group">
                <label>Pr√ºfdatum: *</label>
                <input type="date" name="last_inspection" id="inspectionDate" required>
                <small>Standardm√§√üig auf heute gesetzt</small>
            </div>
            
            <div class="form-group">
                <label>Pr√ºfstatus: *</label>
                <select name="status" id="pruefsStatus" required>
                    <option value="">-- Bitte w√§hlen --</option>
                    <option value="active">‚úÖ Bestanden</option>
                    <option value="false">‚ùå Nicht bestanden</option>
                    <option value="lost">üî¥ Verloren</option>
                </select>
                <small>Status der letzten Pr√ºfung</small>
            </div>
            
            <div class="form-group">
                <label>N√§chste Pr√ºfung:</label>
                <input type="date" name="next_inspection" id="nextInspectionDate">
                <small>Wird automatisch berechnet (12 Monate nach Pr√ºfdatum)</small>
            </div>
        </div>

        
        <div class="form-group">
            <label>Notizen:</label>
            <textarea name="notes" rows="3"></textarea>
        </div>
        
        <div class="button-group">
            <button type="submit" class="btn-primary" id="submitBtn">üíæ Speichern & Weiter</button>
            <button type="button" id="backBtn" class="btn-secondary">üìã Zur Liste</button>
        </div>
    </form>
    
    <div id="message" class="message"></div>
</div>
{% endblock %}

{% block extra_js %}

<script>
// Setze Pr√ºfdatum auf heute
document.addEventListener('DOMContentLoaded', () => {
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('inspectionDate').value = today;
    
    // Berechne auch n√§chste Pr√ºfung initial
    const inspectionDate = new Date(today);
    const nextInspection = new Date(inspectionDate);
    nextInspection.setFullYear(nextInspection.getFullYear() + 1);
    const nextInspectionStr = nextInspection.toISOString().split('T')[0];
    document.getElementById('nextInspectionDate').value = nextInspectionStr;
});

// Berechne n√§chste Pr√ºfung (12 Monate sp√§ter)
document.getElementById('inspectionDate').addEventListener('change', (e) => {
    const inspectionDate = new Date(e.target.value);
    const nextInspection = new Date(inspectionDate);
    nextInspection.setFullYear(nextInspection.getFullYear() + 1);
    const nextInspectionStr = nextInspection.toISOString().split('T')[0];
    document.getElementById('nextInspectionDate').value = nextInspectionStr;
});

// Zur Liste Button
document.getElementById('backBtn').addEventListener('click', () => {
    window.location.href = '{{ url_for("devices") }}';
});

// Generiere Device ID bei Kunde Eingabe
document.getElementById('customerInput').addEventListener('change', async (e) => {
    const customer = e.target.value.trim();
    if (!customer) {
        document.getElementById('deviceId').value = '';
        return;
    }
    try {
        const response = await fetch(`/api/devices/next-id?customer=${encodeURIComponent(customer)}`);
        const result = await response.json();
        if (result.success) {
            document.getElementById('deviceId').value = result.next_id;
        }
    } catch (error) {
        console.error('Fehler:', error);
    }
});

// Form Submit
document.getElementById('quickAddForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);
    const data = Object.fromEntries(formData.entries());
    
    // Validiere Pr√ºfstatus
    if (!data.status) {
        document.getElementById('message').innerHTML = '‚ùå Fehler: Pr√ºfstatus ist erforderlich';
        document.getElementById('message').className = 'message error';
        return;
    }
    
    try {
        const response = await fetch('/api/devices', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });
        const result = await response.json();
        
        if (result.success) {
            document.getElementById('message').innerHTML = '‚úÖ Ger√§t erfolgreich gespeichert!';
            document.getElementById('message').className = 'message success';
            
            if (data.type === 'USB-Kabel') {
                setTimeout(() => {
                    window.location.href = `/device/${result.device.id}/usbc-inspection`;
                }, 1000);
                return;
            }
            
            e.target.reset();
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('inspectionDate').value = today;
            
            // Berechne n√§chste Pr√ºfung
            const inspectionDate = new Date(today);
            const nextInspection = new Date(inspectionDate);
            nextInspection.setFullYear(nextInspection.getFullYear() + 1);
            const nextInspectionStr = nextInspection.toISOString().split('T')[0];
            document.getElementById('nextInspectionDate').value = nextInspectionStr;
            
            const customer = data.customer;
            const response2 = await fetch(`/api/devices/next-id?customer=${encodeURIComponent(customer)}`);
            const result2 = await response2.json();
            
            if (result2.success) {
                document.getElementById('deviceId').value = result2.next_id;
            }
            
            document.querySelector('input[name="name"]').focus();
            setTimeout(() => {
                document.getElementById('message').innerHTML = '';
            }, 3000);
        } else {
            throw new Error(result.error);
        }
    } catch (error) {
        document.getElementById('message').innerHTML = '‚ùå Fehler: ' + error.message;
        document.getElementById('message').className = 'message error';
        console.error('Fehler beim Speichern:', error);
    }
});
</script>

{% endblock %}
